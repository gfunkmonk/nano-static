name: Build Nano Cross-Platform

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      nano_version:
        description: 'Nano version to build'
        required: true
        default: '8.7'
      ncurses_version:
        description: 'Ncurses version to build'
        required: true
        default: '6.6'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: 
          - aarch64
          - armv5
          - armv6
          - armv7
          - i686
          - x86_64
          - loongarch64
          - m68k
          - mips
          - mipsel
          - powerpc
          - powerpc64
          - riscv32
          - riscv64
          - s390x
          - sh4
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget build-essential texinfo file upx-ucl
    
    - name: Set versions
      run: |
        echo "NANO_VERSION=${{ github.event.inputs.nano_version || '8.7' }}" >> $GITHUB_ENV
        echo "NCURSES_VERSION=${{ github.event.inputs.ncurses_version || '6.6' }}" >> $GITHUB_ENV
    
    - name: Build nano for ${{ matrix.arch }}
      run: |
        chmod +x build_nano_enhanced.sh
        ./build.sh ${{ matrix.arch }}
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: nano-${{ matrix.arch }}
        path: output/nano-*-${{ matrix.arch }}*
        retention-days: 30
  
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
